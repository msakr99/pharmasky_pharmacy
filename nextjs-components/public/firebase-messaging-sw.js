// nextjs-components/public/firebase-messaging-sw.js
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// Service Worker ูุงุณุชูุจุงู ุงูุฅุดุนุงุฑุงุช ูู ุงูุฎูููุฉ (Background)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ูุฐุง ุงูููู ูุนูู ูู ุงูุฎูููุฉ ููุณุชูุจู ุงูุฅุดุนุงุฑุงุช ุญุชู ูู ูุงู ุงููุชุตูุญ ูุบูููุง
// 
// ๐ต ุชุญุฏูุซ ุงูุตูุช ุงููุฎุตุต:
// - ุชู ุฅุถุงูุฉ ุชุดุบูู ุตูุช notify.mp3 ุนูุฏ ูุตูู ุงูุฅุดุนุงุฑุงุช
// - ุงูุตูุช ูุชู ุชุดุบููู ูุฏููุงู ุจุงุณุชุฎุฏุงู Audio API ูุถูุงู ุนููู ูู ุฌููุน ุงููุชุตูุญุงุช
// - ุงูุตูุช ูุนูู ุญุชู ูู ูุงู ุงููููุน ูู ุงูุฎูููุฉ ุฃู ููููู

// ุงุณุชูุฑุงุฏ Firebase scripts ููู Service Worker
importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js');

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ุชูููู Firebase - ููุณ ุงูููู ุงููุณุชุฎุฏูุฉ ูู firebase.ts
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// โ๏ธ ููู: ูุฌุจ ุฃู ุชููู ูุฐู ุงูููู ูุทุงุจูุฉ ููุง ูู firebase.ts
const firebaseConfig = {
  apiKey: "AIzaSyD6EDxwyeNIQn_GZY5uE6TN2fj-DCl1zEc",
  authDomain: "pharmasky46.firebaseapp.com",
  projectId: "pharmasky46",
  storageBucket: "pharmasky46.firebasestorage.app",
  messagingSenderId: "161754387145",
  appId: "1:161754387145:web:cdb298fc73219258927318"
};

// ุชููุฆุฉ Firebase ูู Service Worker
firebase.initializeApp(firebaseConfig);

// ุงูุญุตูู ุนูู messaging instance
const messaging = firebase.messaging();

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ูุนุงูุฌุฉ ุงูุฅุดุนุงุฑุงุช ูู ุงูุฎูููุฉ (Background Messages)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉ ุนูุฏูุง ูุตู ุฅุดุนุงุฑ ูุงูุชุทุจูู ููุณ ููุชูุญูุง
messaging.onBackgroundMessage((payload) => {
  console.log('[firebase-messaging-sw.js] Received background message:', payload);

  // ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ูู ุงูุฅุดุนุงุฑ
  const notificationTitle = payload.notification?.title || 'ุฅุดุนุงุฑ ุฌุฏูุฏ';
  const notificationOptions = {
    body: payload.notification?.body || 'ูุฏูู ุฅุดุนุงุฑ ุฌุฏูุฏ',
    icon: payload.notification?.icon || '/icon.png', // ุฃููููุฉ ุงูุชุทุจูู
    badge: '/icon.png', // ุดุงุฑุฉ ุตุบูุฑุฉ
    image: payload.notification?.image || null, // ุตูุฑุฉ ูุจูุฑุฉ (ุงุฎุชูุงุฑู)
    data: payload.data || {}, // ุจูุงูุงุช ุฅุถุงููุฉ
    tag: payload.data?.tag || 'default-tag', // tag ููุชุญูู ูู ุงูุฅุดุนุงุฑุงุช ุงูููุฑุฑุฉ
    requireInteraction: false, // ูู ูุจูู ุงูุฅุดุนุงุฑ ุญุชู ูุชูุงุนู ุงููุณุชุฎุฏู
    silent: false, // ุตูุช ุฃู ุตุงูุช
    vibrate: [200, 100, 200], // ููุท ุงูุงูุชุฒุงุฒ
    sound: '/sounds/notify.mp3', // ุงูุตูุช ุงููุฎุตุต ููุฅุดุนุงุฑ
    // actions: [ // ุฃุฒุฑุงุฑ ูู ุงูุฅุดุนุงุฑ (ุงุฎุชูุงุฑู)
    //   {
    //     action: 'open',
    //     title: 'ูุชุญ',
    //     icon: '/icons/open.png'
    //   },
    //   {
    //     action: 'close',
    //     title: 'ุฅุบูุงู',
    //     icon: '/icons/close.png'
    //   }
    // ]
  };

  // ุนุฑุถ ุงูุฅุดุนุงุฑ
  const notificationPromise = self.registration.showNotification(notificationTitle, notificationOptions);
  
  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  // ุชุดุบูู ุงูุตูุช ูุฏููุงู ูุถูุงู ุนููู ูู ุฌููุน ุงููุชุตูุญุงุช
  // โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  // ููุงุญุธุฉ: ุงูุตูุช ูุชู ุชุดุบููู ูู ุงููุฑููุช ููุท ูุฃู ุงูุจุงู ูุง ูุชุญูู ููู
  // ูุฐุง ูุถูู ุชุดุบูู ุงูุตูุช ุญุชู ูู ูุงู ุงููููุน ูู ุงูุฎูููุฉ ุฃู ููููู
  try {
    // ุฅูุดุงุก Audio object ูุชุดุบูู ุงูุตูุช
    const audio = new Audio('/sounds/notify.mp3');
    audio.volume = 0.8; // ูุณุชูู ุงูุตูุช (0.0 - 1.0)
    audio.play().catch((error) => {
      console.log('[firebase-messaging-sw.js] Audio play failed:', error);
      // ุฅุฐุง ูุดู ุชุดุบูู ุงูุตูุชุ ูุง ูููู ุงูุฅุดุนุงุฑ
    });
  } catch (error) {
    console.log('[firebase-messaging-sw.js] Audio creation failed:', error);
    // ุฅุฐุง ูุดู ุฅูุดุงุก Audio objectุ ูุง ูููู ุงูุฅุดุนุงุฑ
  }

  return notificationPromise;
});

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ูุนุงูุฌุฉ ุงูููุฑ ุนูู ุงูุฅุดุนุงุฑ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
self.addEventListener('notificationclick', (event) => {
  console.log('[firebase-messaging-sw.js] Notification clicked:', event);

  // ุฅุบูุงู ุงูุฅุดุนุงุฑ
  event.notification.close();

  // ุงูุชุนุงูู ูุน ุฃุฒุฑุงุฑ ุงูุฅุดุนุงุฑ (actions)
  if (event.action === 'close') {
    // ุงููุณุชุฎุฏู ุถุบุท ุนูู "ุฅุบูุงู"
    return;
  }

  // ูุชุญ ุฃู ุงูุชุฑููุฒ ุนูู ูุงูุฐุฉ ุงูุชุทุจูู
  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {
      // ุงูุญุตูู ุนูู URL ุงููุทููุจ ูู ุจูุงูุงุช ุงูุฅุดุนุงุฑ
      const urlToOpen = event.notification.data?.url || '/notifications';

      // ุงูุจุญุซ ุนู ูุงูุฐุฉ ููุชูุญุฉ ุจุงููุนู
      for (let i = 0; i < clientList.length; i++) {
        const client = clientList[i];
        // ุฅุฐุง ูุฌุฏูุง ูุงูุฐุฉ ููุชูุญุฉุ ูุฑูุฒ ุนูููุง ูููุชูู ููู URL ุงููุทููุจ
        if (client.url === '/' && 'focus' in client) {
          client.focus();
          return client.navigate(urlToOpen);
        }
      }

      // ุฅุฐุง ูู ูุฌุฏ ูุงูุฐุฉ ููุชูุญุฉุ ููุชุญ ูุงูุฐุฉ ุฌุฏูุฏุฉ
      if (clients.openWindow) {
        return clients.openWindow(urlToOpen);
      }
    })
  );
});

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ูุนุงูุฌุฉ ุฅุบูุงู ุงูุฅุดุนุงุฑ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
self.addEventListener('notificationclose', (event) => {
  console.log('[firebase-messaging-sw.js] Notification closed:', event);
  // ูููู ุฅุถุงูุฉ ุชุชุจุน analytics ููุง
});

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ุฑุณุงูุฉ ุชุฑุญูุจ ุนูุฏ ุชุซุจูุช Service Worker
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
self.addEventListener('install', (event) => {
  console.log('[firebase-messaging-sw.js] Service Worker installed');
  self.skipWaiting(); // ุชูุนูู Service Worker ููุฑูุง
});

self.addEventListener('activate', (event) => {
  console.log('[firebase-messaging-sw.js] Service Worker activated');
  event.waitUntil(clients.claim()); // ุงูุชุญูู ูู ุฌููุน ุงูุตูุญุงุช ููุฑูุง
});

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ููุงุญุธุงุช ูููุฉ:
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// 1. ูุฐุง ุงูููู ูุฌุจ ุฃู ูููู ูู ุฌุฐุฑ ุงููุฌูุฏ public
// 2. ูุง ุชุถุน console.log ูุซูุฑูุง ูู production ูุชุญุณูู ุงูุฃุฏุงุก
// 3. ูููู ุชุฎุตูุต ุดูู ุงูุฅุดุนุงุฑ ุญุณุจ ุงุญุชูุงุฌุงุชู
// 4. ุงูุจูุงูุงุช (payload.data) ูููู ุฃู ุชุญุชูู ุนูู ูุนูููุงุช ุฅุถุงููุฉ ูุซู:
//    - notification_id: ูุนุฑู ุงูุฅุดุนุงุฑ
//    - type: ููุน ุงูุฅุดุนุงุฑ (order, offer, etc.)
//    - url: ุฑุงุจุท ููุงูุชูุงู ุฅููู ุนูุฏ ุงูููุฑ
